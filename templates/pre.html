<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPA Pronunciation Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: #343a40;
            color: white;
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
        }
        .sidebar h4 { color: #0dcaf0; }
        .main-content {
            margin-left: 280px;
            padding: 20px;
        }
        .ipa-card {
            font-size: 1.8rem;
            font-weight: bold;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ipa-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .ipa-card.active { background-color: #28a745 !important; color: white; border: 3px solid #1e7e34; }
        .example-word {
            display: inline-block;
            margin: 5px;
            padding: 8px 16px;
            background-color: #e8f5e9;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.3s;
        }
        .example-word:hover { background-color: #28a745; color: white; }
        .word-display { font-size: 4rem; font-weight: bold; }
        .ipa-display { font-size: 2rem; cursor: pointer; padding: 10px; border-radius: 8px; }
        .ipa-display:hover { background-color: #f0f0f0; }
        #progress { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; display: none; }
        #progress-bar { height: 100%; background: #28a745; width: 0; transition: width 0.1s; }
        @media (max-width: 992px) {
            .sidebar { position: relative; width: 100%; height: auto; }
            .main-content { margin-left: 0; }
            .word-display { font-size: 2.8rem; }
            .ipa-card { font-size: 1.4rem; padding: 15px; }
        }
    </style>
</head>
<body>

<!-- Sidebar b√™n tr√°i -->
<div class="sidebar">
    <h4 class="text-center mb-4"><i class="bi bi-mic-fill"></i> Pronunciation Master</h4>
    <hr class="border-secondary">
    <div class="mb-4">
        <label for="custom-word" class="form-label fw-bold">Luy·ªán t·ª´ t·ª± do</label>
        <input type="text" class="form-control" id="custom-word" placeholder="G√µ t·ª´ ti·∫øng Anh... (vd: hello)">
        <button class="btn btn-info w-100 mt-2" id="btn-practice-custom">
            <i class="bi bi-volume-up"></i> Luy·ªán t·ª´ n√†y
        </button>
    </div>
    <hr class="border-secondary">
    <small class="text-muted">Ho·∫∑c ch·ªçn √¢m IPA b√™n ph·∫£i ƒë·ªÉ luy·ªán theo nh√≥m</small>
</div>

<!-- N·ªôi dung ch√≠nh -->
<div class="main-content">
    <h1 class="text-center text-primary mb-4">IPA PRONUNCIATION MASTER</h1>
    <p class="text-center text-muted mb-5">Ch·ªçn √¢m IPA ho·∫∑c g√µ t·ª´ ·ªü sidebar ƒë·ªÉ luy·ªán ph√°t √¢m chu·∫©n <strong>Anh-Anh</strong></p>

    {% for group_id, group in ipa_data.items() %}
    <div class="mb-5">
        <h3 class="text-primary border-bottom pb-2">{{ group.title }}</h3>
        <div class="row row-cols-4 row-cols-md-6 row-cols-lg-8 g-3" id="{{ group_id }}">
            {% for item in group['items'] %}
            <div class="col">
                <div class="ipa-card bg-light border"
                     onclick='setCurrentSound({{ item|tojson }}, this)'>
                    {{ item.sound }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <div class="text-center my-4">
        <button class="btn btn-warning btn-lg" id="btn-random">Luy·ªán ng·∫´u nhi√™n</button>
    </div>

    <div class="practice-zone card p-4 mt-5 shadow">
        <p class="fs-5">2. H·ªçc c√°ch ph√°t √¢m:</p>
        <div class="guide text-muted fs-5" id="guide">Ch·ªçn m·ªôt √¢m ho·∫∑c g√µ t·ª´ ·ªü sidebar</div>

        <p class="mt-4">Nh·∫•n v√†o phi√™n √¢m ƒë·ªÉ nghe √¢m ri√™ng (n·∫øu c√≥):</p>
        <div class="ipa-display bg-light d-inline-block" id="target-ipa">---</div>

        <div class="examples mt-4" id="examples"></div>

        <p class="mt-4 fs-5">3. Luy·ªán ƒë·ªçc to t·ª´:</p>
        <div class="word-display text-center my-4" id="target-word">---</div>

        <div class="text-center">
            <button class="btn btn-primary btn-lg mx-2" id="btn-play">Nghe m·∫´u t·ª´</button>
            <button class="btn btn-success btn-lg mx-2" id="btn-mic">B·∫•m ƒë·ªÉ n√≥i</button>
        </div>
        <div class="mt-3" id="progress"><div id="progress-bar"></div></div>
        <div class="mt-4 fs-4" id="feedback"></div>
    </div>

    <div class="text-center mt-5 fs-4 text-muted" id="stats">ƒê√∫ng: 0 | Sai: 0</div>
</div>

<script>
    let currentItem = null;
    let currentWord = "";
    let correctCount = 0;
    let wrongCount = 0;
    let audioProgressInterval = null;

    const wordDisplay = document.getElementById('target-word');
    const ipaDisplay = document.getElementById('target-ipa');
    const examplesDiv = document.getElementById('examples');
    const guideDisplay = document.getElementById('guide');
    const btnMic = document.getElementById('btn-mic');
    const btnPlay = document.getElementById('btn-play');
    const btnRandom = document.getElementById('btn-random');
    const feedback = document.getElementById('feedback');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const stats = document.getElementById('stats');
    const customInput = document.getElementById('custom-word');
    const btnPracticeCustom = document.getElementById('btn-practice-custom');

    const ipaData = {{ ipa_data | tojson }};

    // H√†m luy·ªán t·ª´ t·ª± do (g√µ tay)
    btnPracticeCustom.onclick = () => {
        let word = customInput.value.trim();
        if (!word) {
            alert("H√£y g√µ m·ªôt t·ª´ ti·∫øng Anh tr∆∞·ªõc nh√©!");
            return;
        }
        word = word.toLowerCase();
        practiceWord(word);
    };

    // Enter trong input c≈©ng luy·ªán lu√¥n
    customInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') btnPracticeCustom.click();
    });

    function practiceWord(word) {
        // X√≥a active c≈© ·ªü c√°c card IPA
        document.querySelectorAll('.ipa-card').forEach(c => c.classList.remove('active', 'bg-success', 'text-white'));

        currentItem = null; // kh√¥ng li√™n k·∫øt v·ªõi √¢m IPA n√†o
        currentWord = word;

        wordDisplay.innerText = word.charAt(0).toUpperCase() + word.slice(1);
        ipaDisplay.innerText = "---";
        ipaDisplay.onclick = null;

        guideDisplay.innerText = "Luy·ªán ph√°t √¢m t·ª´ b·∫°n t·ª± g√µ. H√£y ƒë·ªçc to v√† r√µ r√†ng!";
        examplesDiv.innerHTML = "";
        feedback.innerHTML = "";
    }

    function setCurrentSound(item, clickedCard = null) {
        document.querySelectorAll('.ipa-card').forEach(c => c.classList.remove('active', 'bg-success', 'text-white'));
        if (clickedCard) clickedCard.classList.add('active', 'bg-success', 'text-white');

        currentItem = item;
        currentWord = item.words[Math.floor(Math.random() * item.words.length)].toLowerCase();

        wordDisplay.innerText = currentWord.charAt(0).toUpperCase() + currentWord.slice(1);
        ipaDisplay.innerText = item.ipa;
        ipaDisplay.onclick = () => speakText(item.approx);

        guideDisplay.innerText = item.guide;
        feedback.innerHTML = "";

        examplesDiv.innerHTML = "<strong class='d-block mb-2'>C√°c t·ª´ v√≠ d·ª• (nh·∫•n ƒë·ªÉ luy·ªán):</strong>";
        item.words.forEach(word => {
            const span = document.createElement('span');
            span.className = 'example-word badge';
            span.innerText = word.charAt(0).toUpperCase() + word.slice(1);
            span.onclick = () => {
                currentWord = word.toLowerCase();
                wordDisplay.innerText = word.charAt(0).toUpperCase() + word.slice(1);
                speakText(word);
            };
            examplesDiv.appendChild(span);
        });
    }

    function speakText(text) {
        if (!text) return;
        const audio = new Audio(`/tts?text=${encodeURIComponent(text)}`);
        audio.play();
    }

    btnPlay.onclick = () => {
        if (!currentWord) return alert("Ch·ªçn ho·∫∑c g√µ m·ªôt t·ª´ ƒë·ªÉ nghe m·∫´u!");
        speakText(wordDisplay.innerText);
    };

    btnRandom.onclick = () => {
        const groupKeys = Object.keys(ipaData);
        const groups = Object.values(ipaData);
        const randomGroupIndex = Math.floor(Math.random() * groups.length);
        const randomGroupKey = groupKeys[randomGroupIndex];
        const randomGroup = groups[randomGroupIndex];
        const randomItemIndex = Math.floor(Math.random() * randomGroup['items'].length);
        const randomItem = randomGroup['items'][randomItemIndex];
        const cards = document.querySelectorAll(`#${randomGroupKey} .ipa-card`);
        const randomCard = cards[randomItemIndex];
        setCurrentSound(randomItem, randomCard);
    };

    function normalizeSpeech(text) {
        return text.toLowerCase().normalize("NFKD").replace(/[^a-z0-9]/g, '').trim();
    }

    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRec ? new SpeechRec() : null;
    if (recognition) {
        recognition.lang = 'en-US';
        recognition.interimResults = true;
    } else {
        btnMic.disabled = true;
        btnMic.innerText = "Mic kh√¥ng h·ªó tr·ª£";
    }

    btnMic.onclick = () => {
        if (!currentWord) return alert("Ch·ªçn ho·∫∑c g√µ m·ªôt t·ª´ ƒë·ªÉ luy·ªán n√≥i!");
        recognition.start();
        btnMic.innerText = "ƒêang nghe...";
        btnMic.disabled = true;
        progress.style.display = 'block';
        progressBar.style.width = '0%';
        feedback.innerHTML = "";
    };

    if (recognition) {
        recognition.onresult = (event) => {
            if (!event.results[0].isFinal) return;
            let transcript = event.results[0][0].transcript;
            let result = normalizeSpeech(transcript);
            let target = normalizeSpeech(currentWord);

            const numberToWord = {'1':'one','2':'two','3':'three','4':'four','5':'five','6':'six','7':'seven','8':'eight','9':'nine'};
            if (numberToWord[result]) result = numberToWord[result];

            stopRecognition();

            if (result === target) {
                feedback.innerHTML = `<span class="text-success fw-bold">TUY·ªÜT V·ªúI! Ch√≠nh x√°c ho√†n h·∫£o üéâ</span>`;
                correctCount++;
            } else {
                feedback.innerHTML = `
                    <span class="text-danger">G·∫ßn ƒë√∫ng r·ªìi! üòä<br>
                    B·∫°n n√≥i: <b>‚Äú${result || transcript}‚Äù</b><br>
                    ƒê√°p √°n: <b>‚Äú${currentWord.charAt(0).toUpperCase() + currentWord.slice(1)}‚Äù</b></span>`;
                wrongCount++;
            }
            stats.innerText = `ƒê√∫ng: ${correctCount} | Sai: ${wrongCount}`;
        };

        recognition.onend = stopRecognition;
        recognition.onerror = () => {
            stopRecognition();
            feedback.innerText = "Kh√¥ng nghe r√µ, th·ª≠ l·∫°i nh√©!";
        };

        recognition.onaudiostart = () => {
            let width = 0;
            if (audioProgressInterval) clearInterval(audioProgressInterval);
            audioProgressInterval = setInterval(() => {
                width += 8;
                progressBar.style.width = `${width}%`;
                if (width >= 100) clearInterval(audioProgressInterval);
            }, 400);
        };
    }

    function stopRecognition() {
        if (recognition) recognition.stop();
        btnMic.innerText = "B·∫•m ƒë·ªÉ n√≥i";
        btnMic.disabled = false;
        progress.style.display = 'none';
    }
</script>
</body>
</html>