{% extends "layout/base.html" %}

{% block title %}Minimal Pairs - Luy·ªán Ph√¢n Bi·ªát √Çm{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #333;
        min-height: 100vh;
    }
    .pairs-container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 15px;
    }
    .pair-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        transition: all 0.3s ease;
        cursor: pointer;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
    }
    .pair-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    }
    .word-box {
        font-size: 2rem;   /* Nh·ªè h∆°n, d·ªÖ nh√¨n */
        font-weight: bold;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
        margin: 10px 0;
    }
    .ipa {
        font-size: 1.3rem;  /* Nh·ªè h∆°n */
        color: #555;
        margin: 8px 0;
    }
    .description {
        font-size: 0.95rem;
        color: #666;
        margin-top: 12px;
        line-height: 1.4;
    }
    .practice-area {
        background: rgba(255,255,255,0.95);
        border-radius: 20px;
        padding: 35px;
        margin: 40px 0;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .current-word {
        font-size: 2.8rem;  /* Nh·ªè h∆°n, v·ª´a ph·∫£i */
        font-weight: bold;
        min-height: 100px;
        color: #333;
        margin: 20px 0;
    }
    #progress {
        height: 10px;
        background: #eee;
        border-radius: 5px;
        overflow: hidden;
        display: none;
        margin: 20px 0;
    }
    #progress-bar {
        height: 100%;
        background: #28a745;
        width: 0;
        transition: width 0.1s;
    }
    .alert {
        border-radius: 12px;
        font-size: 1.1rem;
    }

    /* 5 c·∫∑p 1 h√†ng tr√™n desktop l·ªõn */
    @media (min-width: 1400px) {
        .pair-col { flex: 0 0 20%; max-width: 20%; }
    }
    /* 4 c·∫∑p tr√™n desktop */
    @media (max-width: 1399px) and (min-width: 1200px) {
        .pair-col { flex: 0 0 25%; max-width: 25%; }
    }
    /* 3 c·∫∑p tr√™n tablet */
    @media (max-width: 1199px) and (min-width: 992px) {
        .pair-col { flex: 0 0 33.333%; max-width: 33.333%; }
    }
    /* 2 c·∫∑p tr√™n mobile l·ªõn */
    @media (max-width: 991px) and (min-width: 576px) {
        .pair-col { flex: 0 0 50%; max-width: 50%; }
        .word-box { font-size: 1.8rem; padding: 14px; }
        .current-word { font-size: 2.5rem; }
    }
    /* 1 c·∫∑p tr√™n mobile nh·ªè */
    @media (max-width: 575px) {
        .pair-col { flex: 0 0 100%; max-width: 100%; }
        .word-box { font-size: 2rem; padding: 16px; }
        .current-word { font-size: 2.4rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="pairs-container">
    <h1 class="text-center mb-4 text-dark"><i class="bi bi-ear-fill"></i> Minimal Pairs - Luy·ªán Ph√¢n Bi·ªát √Çm D·ªÖ Nh·∫ßm</h1>
    <p class="text-center lead text-dark mb-5">Ch·ªçn m·ªôt c·∫∑p ƒë·ªÉ luy·ªán nghe v√† n√≥i s·ª± kh√°c bi·ªát</p>

    <div class="row">
        {% for pair in minimal_pairs %}
        <div class="pair-col mb-4">
            <div class="pair-card" onclick="startPractice('{{ pair.id }}')">
                <div class="word-box">{{ pair.word1 }}</div>
                <div class="ipa">{{ pair.ipa1 }}</div>
                <div class="h4 text-muted my-2">VS</div>
                <div class="word-box">{{ pair.word2 }}</div>
                <div class="ipa">{{ pair.ipa2 }}</div>
                <div class="description">{{ pair.description }}</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="practice-area text-center d-none" id="practice-area">
        <h2 class="mb-4 text-dark">Luy·ªán n√≥i: Nghe v√† ƒëo√°n t·ª´ n√†o!</h2>
        <p class="text-muted mb-4">App s·∫Ω ph√°t 1 trong 2 t·ª´ ‚Üí b·∫°n n√≥i theo ‚Üí mic ki·ªÉm tra</p>

        <div class="current-word" id="current-word-display">Ch·ªçn m·ªôt c·∫∑p ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>

        <div class="mt-4">
            <button class="btn btn-primary btn-lg mx-2" id="btn-play-random">
                <i class="bi bi-play-fill"></i> Ph√°t ng·∫´u nhi√™n
            </button>
            <button class="btn btn-success btn-lg mx-2" id="btn-mic-practice">
                <i class="bi bi-mic-fill"></i> B·∫•m ƒë·ªÉ n√≥i
            </button>
            <button class="btn btn-secondary btn-lg mx-2" id="btn-stop-practice">
                <i class="bi bi-stop-fill"></i> D·ª´ng luy·ªán
            </button>
        </div>

        <div id="progress"><div id="progress-bar"></div></div>
        <div class="mt-4" id="feedback"></div>

        <div class="stats text-dark mt-4">
            ƒê√∫ng: <span id="correct-count">0</span> | Sai: <span id="wrong-count">0</span>
        </div>
    </div>

    <div class="text-center mt-5">
        <a href="/" class="btn btn-outline-dark btn-lg"><i class="bi bi-arrow-left"></i> Quay l·∫°i trang ch√≠nh</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const minimalPairs = {{ minimal_pairs | tojson | safe }};

    let currentPair = null;
    let currentRandomWord = null;
    let correctCount = 0;
    let wrongCount = 0;
    let audioProgressInterval = null;

    const practiceArea = document.getElementById('practice-area');
    const currentWordDisplay = document.getElementById('current-word-display');
    const btnPlayRandom = document.getElementById('btn-play-random');
    const btnMicPractice = document.getElementById('btn-mic-practice');
    const btnStopPractice = document.getElementById('btn-stop-practice');
    const feedback = document.getElementById('feedback');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const correctSpan = document.getElementById('correct-count');
    const wrongSpan = document.getElementById('wrong-count');

    function startPractice(pairId) {
        currentPair = minimalPairs.find(p => p.id === pairId);
        practiceArea.classList.remove('d-none');
        currentWordDisplay.innerText = `S·∫µn s√†ng luy·ªán: ${currentPair.word1} vs ${currentPair.word2}`;
        feedback.innerHTML = "";
        window.scrollTo({ top: practiceArea.offsetTop - 100, behavior: 'smooth' });
    }

    function playRandomWord() {
        if (!currentPair) return;
        const words = [currentPair.word1, currentPair.word2];
        currentRandomWord = words[Math.floor(Math.random() * words.length)];
        currentWordDisplay.innerText = "Nghe k·ªπ v√† n√≥i l·∫°i t·ª´ b·∫°n nghe ƒë∆∞·ª£c...";
        speakText(currentRandomWord);
    }

    function speakText(text) {
        const audio = new Audio(`/tts?text=${encodeURIComponent(text)}`);
        audio.play();
    }

    btnPlayRandom.onclick = playRandomWord;

    btnStopPractice.onclick = () => {
        practiceArea.classList.add('d-none');
        currentPair = null;
        currentRandomWord = null;
        feedback.innerHTML = "";
    };

    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRec ? new SpeechRec() : null;
    if (recognition) recognition.lang = 'en-GB';

    btnMicPractice.onclick = () => {
        if (!currentRandomWord) {
            alert("H√£y nh·∫•n 'Ph√°t ng·∫´u nhi√™n' tr∆∞·ªõc!");
            return;
        }
        recognition.start();
        btnMicPractice.innerText = "ƒêang nghe...";
        btnMicPractice.disabled = true;
        progress.style.display = 'block';
        progressBar.style.width = '0%';
        feedback.innerHTML = "";

        let width = 0;
        audioProgressInterval = setInterval(() => {
            width += 5;
            progressBar.style.width = `${width}%`;
            if (width >= 100) clearInterval(audioProgressInterval);
        }, 200);
    };

    function normalize(text) {
        return text.toLowerCase().normalize("NFKD").replace(/[^a-z0-9]/g, '');
    }

    if (recognition) {
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.trim();
            const result = normalize(transcript);
            const target = normalize(currentRandomWord);

            clearInterval(audioProgressInterval);

            if (result === target) {
                feedback.innerHTML = `<div class="alert alert-success">CH√çNH X√ÅC! üéâ B·∫°n n√≥i ƒë√∫ng: <strong>${currentRandomWord}</strong></div>`;
                correctCount++;
                correctSpan.innerText = correctCount;
            } else {
                feedback.innerHTML = `
                    <div class="alert alert-warning">
                        Sai r·ªìi! üòÖ<br>
                        B·∫°n n√≥i: <strong>${transcript}</strong><br>
                        T·ª´ ƒë√∫ng l√†: <strong>${currentRandomWord}</strong><br>
                        H√£y ch√∫ √Ω s·ª± kh√°c bi·ªát gi·ªØa <strong>${currentPair.word1}</strong> v√† <strong>${currentPair.word2}</strong>
                    </div>`;
                wrongCount++;
                wrongSpan.innerText = wrongCount;
            }
        };

        recognition.onend = () => {
            btnMicPractice.innerText = "B·∫•m ƒë·ªÉ n√≥i";
            btnMicPractice.disabled = false;
            progress.style.display = 'none';
        };
    }
</script>
{% endblock %}