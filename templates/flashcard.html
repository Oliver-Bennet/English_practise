{% extends "layout/base.html" %}

{% block title %}Flashcard - √în T·ª´ V·ª±ng & Ph√°t √Çm{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
    }
    .card-container {
        max-width: 900px;
        margin: 40px auto;
    }
    .flashcard {
        height: 420px;
        perspective: 1000px;
        cursor: pointer;
    }
    .flashcard-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        transform-style: preserve-3d;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    .flashcard.flipped .flashcard-inner {
        transform: rotateY(180deg);
    }
    .front, .back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        padding: 40px;
    }
    .front {
        background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        color: #333;
    }
    .back {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
        transform: rotateY(180deg);
    }
    .word {
        font-size: 4.5rem;
        font-weight: bold;
    }
    .ipa {
        font-size: 2rem;
        margin: 20px 0;
        color: #555;
    }
    .meaning {
        font-size: 2rem;
        font-style: italic;
    }
    .controls {
        margin-top: 40px;
    }
    .stats {
        font-size: 1.4rem;
        margin-top: 30px;
    }
    #progress {
        height: 10px;
        background: rgba(255,255,255,0.3);
        border-radius: 5px;
        overflow: hidden;
        display: none;
        margin: 20px 0;
    }
    #progress-bar {
        height: 100%;
        background: #28a745;
        width: 0;
        transition: width 0.1s;
    }
    .alert {
        border-radius: 12px;
    }
    @media (max-width: 768px) {
        .word { font-size: 3rem; }
        .flashcard { height: 380px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="card-container">
    <h1 class="text-center mb-4"><i class="bi bi-card-list"></i> Flashcard - √în T·ª´ V·ª±ng & Ph√°t √Çm</h1>

    <!-- Thanh th√™m t·ª´ m·ªõi -->
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="input-group">
                <input type="text" class="form-control form-control-lg" id="new-word-input" placeholder="G√µ t·ª´ m·ªõi mu·ªën th√™m (vd: extraordinary)">
                <button class="btn btn-success btn-lg" id="btn-add-word">
                    <i class="bi bi-plus-circle"></i> Th√™m v√†o Flashcard
                </button>
            </div>
            <small class="text-light d-block text-center mt-2">T·ª´ m·ªõi s·∫Ω ƒë∆∞·ª£c l∆∞u t·∫°m trong tr√¨nh duy·ªát n√†y</small>
        </div>
    </div>

    <div class="flashcard" id="flashcard">
        <div class="flashcard-inner">
            <div class="front">
                <div class="word" id="front-word">Nh·∫•n Space ho·∫∑c n√∫t L·∫≠t th·∫ª ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
            </div>
            <div class="back">
                <div class="word" id="back-word"></div>
                <div class="ipa" id="back-ipa"></div>
                <div class="meaning" id="back-meaning"></div>
                <div class="mt-4">
                    <button class="btn btn-lg btn-primary mx-2" id="btn-play-back">
                        <i class="bi bi-volume-up-fill"></i> Nghe t·ª´
                    </button>
                    <button class="btn btn-lg btn-success mx-2" id="btn-mic-back">
                        <i class="bi bi-mic-fill"></i> Luy·ªán n√≥i
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="progress"><div id="progress-bar"></div></div>
    <div class="text-center" id="feedback"></div>

    <div class="controls text-center">
        <button class="btn btn-outline-light btn-lg mx-2" id="btn-previous" title="Quay l·∫°i th·∫ª tr∆∞·ªõc">
            <i class="bi bi-arrow-left-circle-fill"></i> Previous
        </button>
        <button class="btn btn-outline-light btn-lg mx-2" id="btn-flip">
            <i class="bi bi-arrow-repeat"></i> L·∫≠t th·∫ª (Space)
        </button>
        <button class="btn btn-warning btn-lg mx-2" id="btn-skip" title="T√¥i bi·∫øt r·ªìi, b·ªè qua t·ª´ n√†y">
            <i class="bi bi-check2-circle"></i> B·ªè qua
        </button>
        <button class="btn btn-outline-light btn-lg mx-2" id="btn-next">
            <i class="bi bi-skip-forward-fill"></i> Ti·∫øp theo
        </button>
    </div>

    <div class="stats text-center">
        <span id="stats">ƒê√∫ng: 0 | Sai: 0</span> |
        <span id="total-cards">T·ªïng th·∫ª: <span id="card-count">0</span></span>
    </div>

    <div class="text-center mt-4">
        <a href="/" class="btn btn-secondary btn-lg"><i class="bi bi-arrow-left"></i> Quay l·∫°i trang IPA</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load flashcard t·ª´ server (t·ª´ data/flashcards.json)
    let flashcards = {{ flashcards | tojson | safe }};

    // G·ªôp v·ªõi localStorage (n·∫øu ng∆∞·ªùi d√πng ƒë√£ th√™m t·ª´ m·ªõi)
    const saved = localStorage.getItem('customFlashcards');
    if (saved) {
        const localCards = JSON.parse(saved);
        localCards.forEach(card => {
            if (!flashcards.some(c => c.word === card.word)) {
                flashcards.push(card);
            }
        });
    }

    let history = [];
    let currentCard = null;
    let skippedCards = new Set();
    let correctCount = 0;
    let wrongCount = 0;
    let audioProgressInterval = null;

    const frontWord = document.getElementById('front-word');
    const backWord = document.getElementById('back-word');
    const backIpa = document.getElementById('back-ipa');
    const backMeaning = document.getElementById('back-meaning');
    const flashcard = document.getElementById('flashcard');
    const btnFlip = document.getElementById('btn-flip');
    const btnNext = document.getElementById('btn-next');
    const btnPrevious = document.getElementById('btn-previous');
    const btnSkip = document.getElementById('btn-skip');
    const btnPlayBack = document.getElementById('btn-play-back');
    const btnMicBack = document.getElementById('btn-mic-back');
    const feedback = document.getElementById('feedback');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const stats = document.getElementById('stats');
    const cardCount = document.getElementById('card-count');
    const newWordInput = document.getElementById('new-word-input');
    const btnAddWord = document.getElementById('btn-add-word');

    function updateCardCount() {
        cardCount.innerText = flashcards.length;
    }

    function saveToLocalStorage() {
        localStorage.setItem('customFlashcards', JSON.stringify(flashcards));
    }

    function loadRandomCard(skipSkipped = true) {
        if (flashcards.length === 0) {
            frontWord.innerText = "Ch∆∞a c√≥ t·ª´ n√†o!";
            return;
        }

        let available = flashcards.filter(card => !skipSkipped || !skippedCards.has(card.word));
        if (available.length === 0) {
            skippedCards.clear();
            available = flashcards;
            feedback.innerHTML = `<div class="alert alert-info">ƒê√£ reset c√°c t·ª´ b·ªã b·ªè qua!</div>`;
        }

        currentCard = available[Math.floor(Math.random() * available.length)];
        history.push(currentCard);

        frontWord.innerText = currentCard.word.charAt(0).toUpperCase() + currentCard.word.slice(1);
        backWord.innerText = currentCard.word.charAt(0).toUpperCase() + currentCard.word.slice(1);
        backIpa.innerText = currentCard.ipa || "(kh√¥ng c√≥ IPA)";
        backMeaning.innerText = currentCard.meaning || "(ch∆∞a c√≥ nghƒ©a)";

        flashcard.classList.remove('flipped');
        feedback.innerHTML = "";
        progress.style.display = 'none';
    }

    function speakText(text) {
        if (!text) return;
        const audio = new Audio(`/tts?text=${encodeURIComponent(text)}`);
        audio.play();
    }

    btnPlayBack.onclick = () => speakText(currentCard.word);
    btnFlip.onclick = () => flashcard.classList.toggle('flipped');
    btnNext.onclick = loadRandomCard;
    btnSkip.onclick = () => {
        skippedCards.add(currentCard.word);
        feedback.innerHTML = `<div class="alert alert-warning">ƒê√£ b·ªè qua t·ª´ "<strong>${currentCard.word}</strong>" trong phi√™n n√†y.</div>`;
        loadRandomCard();
    };

    btnPrevious.onclick = () => {
        if (history.length > 1) {
            history.pop();
            currentCard = history[history.length - 1];
            frontWord.innerText = currentCard.word.charAt(0).toUpperCase() + currentCard.word.slice(1);
            backWord.innerText = currentCard.word.charAt(0).toUpperCase() + currentCard.word.slice(1);
            backIpa.innerText = currentCard.ipa || "(kh√¥ng c√≥ IPA)";
            backMeaning.innerText = currentCard.meaning || "(ch∆∞a c√≥ nghƒ©a)";
            flashcard.classList.remove('flipped');
            feedback.innerHTML = `<div class="alert alert-info">ƒê√£ quay l·∫°i th·∫ª tr∆∞·ªõc!</div>`;
        }
    };

    btnAddWord.onclick = () => {
        let word = newWordInput.value.trim().toLowerCase();
        if (!word) {
            alert("H√£y g√µ m·ªôt t·ª´ ti·∫øng Anh!");
            return;
        }
        if (flashcards.some(c => c.word === word)) {
            alert(`T·ª´ "${word}" ƒë√£ t·ªìn t·∫°i!`);
            return;
        }

        flashcards.push({
            word: word,
            ipa: "(t·ª± tra)",
            meaning: "(t·ª± th√™m nghƒ©a)"
        });

        saveToLocalStorage();
        updateCardCount();
        newWordInput.value = '';
        feedback.innerHTML = `<div class="alert alert-success">ƒê√£ th√™m t·ª´ "<strong>${word}</strong>" th√†nh c√¥ng!</div>`;
    };

    newWordInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') btnAddWord.click();
    });

    document.addEventListener('keydown', e => {
        if (e.code === 'Space') {
            e.preventDefault();
            flashcard.classList.toggle('flipped');
        }
    });

    // Speech Recognition
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRec ? new SpeechRec() : null;
    if (recognition) recognition.lang = 'en-US';

    btnMicBack.onclick = () => {
        if (!currentCard) {
            alert("Ch∆∞a c√≥ th·∫ª n√†o! Nh·∫•n Ti·∫øp theo ƒë·ªÉ b·∫Øt ƒë·∫ßu.");
            return;
        }
        recognition.start();
        btnMicBack.innerText = "ƒêang nghe...";
        btnMicBack.disabled = true;
        progress.style.display = 'block';
        progressBar.style.width = '0%';
        feedback.innerHTML = "";
    };

    function normalizeSpeech(text) {
        return text.toLowerCase().normalize("NFKD").replace(/[^a-z0-9]/g, '').trim();
    }

    if (recognition) {
        recognition.onresult = event => {
            if (!event.results[0].isFinal) return;
            let transcript = event.results[0][0].transcript;
            let result = normalizeSpeech(transcript);
            let target = normalizeSpeech(currentCard.word);

            stopRecognition();

            if (result === target) {
                feedback.innerHTML = `<div class="alert alert-success mt-3">TUY·ªÜT V·ªúI! Ch√≠nh x√°c ho√†n h·∫£o üéâ</div>`;
                correctCount++;
            } else {
                feedback.innerHTML = `<div class="alert alert-warning mt-3">G·∫ßn ƒë√∫ng r·ªìi! üòä<br>B·∫°n n√≥i: <b>‚Äú${transcript}‚Äù</b><br>ƒê√°p √°n: <b>‚Äú${currentCard.word}‚Äù</b></div>`;
                wrongCount++;
            }
            stats.innerText = `ƒê√∫ng: ${correctCount} | Sai: ${wrongCount}`;
        };

        recognition.onend = stopRecognition;
        recognition.onerror = () => {
            stopRecognition();
            feedback.innerHTML = `<div class="alert alert-danger mt-3">Kh√¥ng nghe r√µ, th·ª≠ l·∫°i nh√©!</div>`;
        };

        recognition.onaudiostart = () => {
            let width = 0;
            if (audioProgressInterval) clearInterval(audioProgressInterval);
            audioProgressInterval = setInterval(() => {
                width += 8;
                progressBar.style.width = `${width}%`;
                if (width >= 100) clearInterval(audioProgressInterval);
            }, 400);
        };
    }

    function stopRecognition() {
        if (recognition) recognition.stop();
        btnMicBack.innerText = "Luy·ªán n√≥i";
        btnMicBack.disabled = false;
        progress.style.display = 'none';
    }

    // Kh·ªüi ƒë·ªông
    updateCardCount();
    loadRandomCard();
</script>
{% endblock %}